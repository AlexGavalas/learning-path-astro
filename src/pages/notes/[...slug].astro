---
import { getAllNoteIds, getNoteData, getNoteMetadata } from "../../api/notes";
import NotesLayout from "../../layouts/notes.astro";
import { Markdown } from "../../components/markdown";

export async function getStaticPaths() {
    const posts = await getAllNoteIds();

    if (!posts) {
        throw new Error("No posts found");
    }

    return await Promise.all(
        posts.map(async (post) => {
            const metaPromise = getNoteMetadata(post.id);
            const contentPromise = getNoteData(post.id);

            const [meta, content] = await Promise.all([
                metaPromise,
                contentPromise,
            ]);

            return {
                params: {
                    slug: post.id,
                },
                props: {
                    content: content?.replace(/\s*---(.|\s)*?---\s*/, "") ?? "",
                    meta,
                },
            };
        })
    );
}

type Props = {
    content: string;
    meta: {
        created: string;
        filename: string;
        id: number;
        line: string;
        title: string;
        updated: string;
    };
};

const { content, meta } = Astro.props;
---

<NotesLayout {...meta}>
    <div
        class="heading dark:dark-heading prose dark:prose-invert prose-headings:text-light-primary prose-li:marker:text-light-primary dark:prose-headings:text-dark-primary dark:prose-li:marker:text-dark-primary"
    >
        <Markdown content={content} />
    </div>
</NotesLayout>
