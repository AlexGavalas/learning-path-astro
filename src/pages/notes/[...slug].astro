---
import { getAllNoteIds, getNoteData, getNoteMetadata } from "../../api/notes";
import NotesLayout from "../../layouts/notes.astro";
import { Markdown } from "../../components/markdown";

export async function getStaticPaths() {
    const posts = await getAllNoteIds();

    if (!posts) {
        throw new Error("No posts found");
    }

    const removeFrontmatter = (s: string | null) =>
        s?.replace(/\s*---(.|\s)*?---\s*/, "");

    return await Promise.all(
        posts.map(async (post) => {
            const metaPromise = getNoteMetadata(post.id);
            const contentPromise = getNoteData(post.id);

            const [meta, content] = await Promise.all([
                metaPromise,
                contentPromise,
            ]);

            return {
                params: {
                    slug: post.id,
                },
                props: {
                    content: removeFrontmatter(content) ?? "",
                    meta,
                },
            };
        })
    );
}

type Props = {
    content: string;
    meta: {
        created: string;
        filename: string;
        id: number;
        line: string;
        title: string;
        updated: string;
    };
};

const { content, meta } = Astro.props;
---

<NotesLayout {...meta}>
    <Markdown content={content} />
</NotesLayout>
